#!/usr/bin/env -S birb-task -f

imports:
  tools: tasks_2.yaml
  tasks_3: tasks_3.json
  tasks_4: tasks_4.json.nu

tasks:
  car:
    description: |
      Build a **car**

      This is a *very* long **description** for the `car` ***task***.
    deps:
      - tasks_3:hello
      - tasks_4:hello
      - task: engine
        with: # or args
          configuration: v8
    sources:
    - plan.txt
    - engine-v8.yaml
    outputs:
    - car.yaml
    steps:
    - run: echo "This is a car recipe"
    - run: echo "It generates a car.yaml file"
    - echo car.yaml > car.yaml

  engine:
    description: Build an engine
    params:
      configuration:
        type: [v6, v8]
        default: v6
    deps:
      - task: workbench
    sources:
    - engine_plan.txt
    - workbench.yaml
    outputs:
    - engine-{{ configuration }}.yaml
    steps:
    - echo "Building engine with configuration {{ configuration }}"
    - 'echo "cfg: {{ configuration }}" > engine-{{ configuration }}.yaml'

  workbench:
    #phony: true
    deps:
    - task: tools:crankshaft
    - task: p
      with: { id: 1 }
    - task: p
      with: { id: 2 }
    - task: p
      with: { id: 3 }
    #- task: p
    #  with: { id: 4 }
    #- task: p
    #  with: { id: 5 }
    #- task: p
    #  with: { id: 6 }
    #- task: p
    #  with: { id: 7 }
    #- task: p
    #  with: { id: 8 }
    #- task: p
    #  with: { id: 9 }
    #- task: p
    #  with: { id: 10 }
    outputs:
    - workbench.yaml
    steps:
    - echo "Workbench prepared at " $(date) > workbench.yaml


  p:
    params:
      id: number
    steps:
    - |
      #!/usr/bin/env bash
      set_title() {
        echo -ne "setting title"
        echo "OK"
        echo -ne "\033]0;$1\007"
      }

      #trap 'echo "p_{{ id }}: Received SIGINT, exiting..."; exit 130' INT
      #trap 'echo "p_{{ id }}: Received SIGTERM, exiting..."; exit 143' TERM
      trap 'echo "p_{{ id }}: Received SIGINT, exiting..."; exit 0' INT
      trap 'echo "p_{{ id }}: Received SIGTERM, exiting..."; exit 0' TERM

      for i in $(seq 0 50); do
        set_title "p_{{ id }} step $i"
        echo "Step $i from p_{{ id }}"
        sleep 0.1
      done